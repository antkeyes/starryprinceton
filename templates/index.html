{% extends "base.html" %}
{% block content %}

<!-- HERO/HEADER SECTION (Now using new class names) -->
<div class="hero-banner p-5 mb-4 rounded-3">
  <div class="container-fluid py-5 hero-text">
    <h1 class="display-5 fw-bold">Princeton, Save Our Dark Skies</h1>
    <p class="col-md-8 fs-4">
      Learn how excessive lighting is affecting our campus environmentâ€”and how you can help.
    </p>
  </div>
</div>

<!-- student testimonials -->
<section id="testimonials" class="mb-5">
  <h2>Student Testimonials</h2>
  <!-- Parent container to control overall slider width -->
  <div class="swiper-parent">
    <!-- Swiper container -->
    <div class="swiper-container testimonials-carousel">
      <div class="swiper-wrapper">
        {% for testimony in csv_testimonies %}
        <div class="swiper-slide">
          <div
            class="testimonial-card {% if testimony.grading_gb == '1' or testimony.grading_ak == '1' %}green-border{% endif %}">
            <!-- Logo circle -->
            <div class="testimonial-logo">
              <img src="{{ url_for('static', filename='images/Princeton_seal.svg') }}" alt="Princeton Seal">
            </div>

            <!-- Header: first name + last initial, then class year -->
            <div class="testimonial-header">
              <p class="grad-year">
                {% if testimony.graduation_year|int <= 2024 %} Alumni {% elif testimony.graduation_year|int> 2014 %}
                  Student
                  {% else %}
                  <!-- Possibly fallback text or an empty string if year is missing -->
                  {% endif %}
              </p>
              {% if testimony.graduation_year %}
              <p class="grad-year">
                Class of {{ testimony.graduation_year }}
              </p>
              {% endif %}
            </div>

            <!-- Content: question and answer pairs -->
            <div class="testimonial-content">
              <div class="question-answer">
                <p class="question">Do you see a value in Princeton having a starry sky? Describe your relevant
                  experience.</p>
                <p class="answer">{{ testimony.q1_answer }}</p>
              </div>
              <div class="question-answer">
                <p class="question">Did you experience light pollution on campus, and how did it disturb you?</p>
                <p class="answer">{{ testimony.q2_answer }}</p>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- (Optional) Pagination -->
      <div class="swiper-pagination"></div>
    </div>

    <!-- Navigation arrows placed underneath -->
    <div class="swiper-navigation">
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

    <!-- New: Read More Testimonials Button -->
    <div class="text-center mt-3">
      <a href="{{ url_for('testimonials_page') }}" class="btn btn-primary">Read All Testimonials</a>
    </div>
  </div>
</section>


<!-- SECTION: Google Photos Album -->
{% if google_photos_media %}
<section id="google-photos" class="mb-5">
  <h2>Google Photos Album</h2>
  <div class="row">
    {% for item in google_photos_media %}
    <div class="col-md-4 mb-3">
      <div class="card">
        {% if "image" in item.mimeType %}
        <a href="{{ item.baseUrl }}=w1600-h1200" class="glightbox" data-gallery="album" data-type="image"
          data-title="{{ custom_descriptions[item.id] if item.id in custom_descriptions else 'No description available' }}">
          <img src="{{ item.baseUrl }}=w400-h300" alt="Google Photo" class="card-img-top">
        </a>
        {% elif "video" in item.mimeType %}
        <a href="{{ item.baseUrl }}=dv" class="glightbox" data-gallery="album" data-type="video"
          data-title="{{ custom_descriptions[item.id] if item.id in custom_descriptions else 'No description available' }}">
          <video class="card-img-top" style="max-height:200px;">
            <source src="{{ item.baseUrl }}=dv" type="{{ item.mimeType }}">
            Your browser does not support the video tag.
          </video>
        </a>
        {% endif %}
        <div class="card-body">
          <!-- Display the current description -->
          <p class="card-text" id="desc-{{ item.id }}">
            {{ custom_descriptions[item.id] if item.id in custom_descriptions else 'No description available' }}
          </p>
          <!-- Edit button to toggle the form -->
          <button class="btn btn-sm btn-outline-primary" onclick="toggleEditForm('{{ item.id }}')">Edit
            Description</button>
          <!-- Hidden form for editing the description -->
          <form method="POST" action="{{ url_for('update_description') }}" id="edit-form-{{ item.id }}"
            style="display: none; margin-top: 10px;">
            <input type="hidden" name="media_item_id" value="{{ item.id }}">
            <textarea name="description" class="form-control" rows="2"
              placeholder="Enter description">{{ custom_descriptions[item.id] if item.id in custom_descriptions else '' }}</textarea>
            <button type="submit" class="btn btn-sm btn-primary mt-2">Save</button>
          </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
{% else %}
<section id="google-photos">
  <p>No Google Photos available. Please <a href="{{ url_for('authorize') }}">authorize</a> the app to view your album.
  </p>
</section>
{% endif %}



<!-- SECTION 3: CURATED PHOTOS & VIDEOS -->
<!-- <section id="curated-media" class="mb-5">
  <h2>Curated Campus Media</h2>
  <div class="row">
    {% for media in curated_media %}
    <div class="col-md-4 mb-3">
      <div class="card">
        {% if media.type == "image" %}
        <img src="{{ media.src }}" class="card-img-top" alt="Curated campus media">
        {% elif media.type == "video" %}
        <video controls class="w-100">
          <source src="{{ media.src }}" type="video/mp4">
          Your browser does not support HTML5 video.
        </video>
        {% endif %}
        <div class="card-body">
          <p class="card-text">{{ media.description }}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section> -->

<section id="user-submissions" class="mb-5">
  <h2>Share Your Photos & Videos</h2>
  <p>
    Help us document light pollution on campus by uploading your own photos or videos and tagging their location.
  </p>

  <!-- Upload Form -->
  <form action="{{ url_for('index') }}" method="POST" enctype="multipart/form-data" class="mb-4">
    <!-- File Upload -->
    <div class="mb-3">
      <label for="media_file" class="form-label">Select Image</label>
      <input class="form-control" type="file" id="media_file" name="media_file" accept="image/*" required>
    </div>

    <!-- Image Description -->
    <div class="mb-3">
      <label for="description" class="form-label">Image Description</label>
      <input type="text" class="form-control" id="description" name="description"
        placeholder="Describe the image and where it was taken" required>
    </div>

    <!-- Your Name -->
    <div class="mb-3">
      <label for="user_name" class="form-label">
        Your Name <span class="text-muted">(Optional)</span>
      </label>
      <input type="text" class="form-control" id="user_name" name="user_name" placeholder="Enter your name">
    </div>

    <!-- Location Picker -->
    <!-- Location Picker -->
    <div class="mb-3">
      <label for="location" class="form-label">Location</label>
      <!-- Map container for location selection -->
      <div id="map" style="height: 300px;"></div>
      <!-- Hidden fields to store latitude and longitude -->
      <input type="hidden" id="latitude" name="latitude">
      <input type="hidden" id="longitude" name="longitude">
      <small class="form-text text-muted">
        Click on the map to select where the photo was taken (Princeton campus).
      </small>
    </div>


    <button type="submit" class="btn btn-primary">Upload</button>
  </form>

  <!-- Display User Submissions -->
  <h3>Recent Submissions</h3>
  <div class="row">
    {% for submission in user_submissions %}
    <div class="col-md-4 mb-3">
      <div class="card user-submission-card">
        {# If the submission file is an image, display it #}
        {% set ext = submission.filename.split('.')[-1]|lower %}
        {% if ext in ['png', 'jpg', 'jpeg', 'gif'] %}
        <img src="{{ url_for('static', filename='uploads/' ~ submission.filename) }}" class="card-img-top"
          alt="User submitted image">
        {% endif %}
        <div class="card-body">
          <p>{{ submission.description }}</p>
          {% if submission.user_name %}
          <p><strong>Submitted by:</strong> {{ submission.user_name }}</p>
          {% endif %}
          {% if submission.latitude and submission.longitude %}
          {# Construct the static map URL #}
          {% set map_url = "https://maps.googleapis.com/maps/api/staticmap?center="
          ~ submission.latitude ~ "," ~ submission.longitude
          ~ "&zoom=16&size=200x200&markers=color:red%7C"
          ~ submission.latitude ~ "," ~ submission.longitude
          ~ "&key=AIzaSyDzOZrj3M3hse4aBLL4sZrFnelsVdz12HQ" %}
          {# Construct the Google Maps link URL #}
          {% set maps_link = "https://www.google.com/maps/search/?api=1&query="
          ~ submission.latitude ~ "," ~ submission.longitude %}
          {# Wrap the image in an anchor tag so it's clickable #}
          <a href="{{ maps_link }}" target="_blank">
            <img src="{{ map_url }}" alt="Map" style="width:200px; height:200px; display:block; margin-top:10px;">
          </a>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>


</section>


{% endblock %}