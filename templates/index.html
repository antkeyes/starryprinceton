{% extends "base.html" %}
{% block content %}

<div class="background-container">
  <div class="stars"></div>
  <div class="twinkling"></div>
</div>

<!-- HERO/HEADER SECTION (Now using new class names) -->
<div class="hero-banner p-5 mb-4 rounded-3">
  <div class="container-fluid py-5 hero-text">
    <h1 class="display-5 fw-bold">Princeton, Save Our Dark Skies</h1>
    <p class="col-md-8 fs-4">
      Learn how excessive lighting is affecting our campus environmentâ€”and how you can help.
    </p>
  </div>
</div>

<!-- Student Testimonials using Flickity -->
<section id="testimonials" class="mb-5">
  <h2>Student Testimonials</h2>
  <!-- Flickity carousel container -->
  <div class="testimonial-carousel" data-flickity='{ "cellAlign": "left", "contain": true, "pageDots": false, "prevNextButtons": true }'>
    {% for testimony in csv_testimonies %}
    <div class="carousel-cell">
      <div class="testimonial-card {% if testimony.grading_gb == '1' or testimony.grading_ak == '1' %}green-border{% endif %}">
        <!-- Logo circle -->
        <div class="testimonial-logo">
          <img src="{{ url_for('static', filename='images/Princeton_seal.svg') }}" alt="Princeton Seal">
        </div>
        <!-- Header: first name + last initial, then class year -->
        <div class="testimonial-header">
          <p class="grad-year">
            {% if testimony.graduation_year|int <= 2024 %} Alumni {% elif testimony.graduation_year|int > 2014 %}
              Student
            {% endif %}
          </p>
          {% if testimony.graduation_year %}
          <p class="grad-year">
            Class of {{ testimony.graduation_year }}
          </p>
          {% endif %}
        </div>
        <!-- Content: question and answer pairs -->
        <div class="testimonial-content">
          <div class="question-answer">
            <p class="question">
              Do you see a value in Princeton having a starry sky? Describe your relevant experience.
            </p>
            <p class="answer">{{ testimony.q1_answer }}</p>
          </div>
          <div class="question-answer">
            <p class="question">
              Did you experience light pollution on campus, and how did it disturb you?
            </p>
            <p class="answer">{{ testimony.q2_answer }}</p>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  <!-- Read More Testimonials Button -->
  <div class="text-center mt-3">
    <a href="{{ url_for('testimonials_page') }}" class="btn btn-primary">Read All Testimonials</a>
  </div>
</section>

<!-- SECTION: Google Photos Album -->
{% if google_photos_media %}
<section id="google-photos" class="mb-5">
  <h2>Google Photos Album</h2>
  <!-- NEW SCROLLABLE WRAPPER (500px height + vertical scroll) -->
  <div class="google-photos-container">
    <div class="row">
      {% for item in google_photos_media %}
      <div class="col-md-4 mb-3">
        <div class="card">
          {% if "image" in item.mimeType %}
          <a href="{{ item.baseUrl }}=w1600-h1200" class="glightbox" data-gallery="album" data-type="image"
            data-title="{{ custom_descriptions[item.id] if item.id in custom_descriptions else 'No description available' }}">
            <!-- IMAGE THUMBNAIL: add 'media-thumbnail' -->
            <img src="{{ item.baseUrl }}=w400-h300" alt="Google Photo" class="card-img-top media-thumbnail">
          </a>
          {% elif "video" in item.mimeType %}
          <a href="{{ item.baseUrl }}=dv" class="glightbox" data-gallery="album" data-type="video"
              data-title="{{ custom_descriptions[item.id] if item.id in custom_descriptions else 'No description available' }}">
            <div class="card-img-top video-container">
              <!-- Use an <img> for the thumbnail so it reliably loads -->
              <img src="{{ item.baseUrl }}=w400-h300" alt="Video Thumbnail" class="media-thumbnail">
            </div>
          </a>
          {% endif %}
          <div class="card-body">
            <p class="card-text" id="desc-{{ item.id }}">
              {{ custom_descriptions[item.id] if item.id in custom_descriptions else 'No description available' }}
            </p>
            <button class="btn btn-sm btn-outline-primary" onclick="toggleEditForm('{{ item.id }}')">
              Edit Description
            </button>
            <form method="POST" action="{{ url_for('update_description') }}" id="edit-form-{{ item.id }}"
              style="display: none; margin-top: 10px;">
              <input type="hidden" name="media_item_id" value="{{ item.id }}">
              <textarea name="description" class="form-control" rows="2"
                placeholder="Enter description">{{ custom_descriptions[item.id] if item.id in custom_descriptions else '' }}</textarea>
              <button type="submit" class="btn btn-sm btn-primary mt-2">Save</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div> <!-- .row -->
  </div>  <!-- .google-photos-container -->
</section>
{% else %}
<section id="google-photos">
  <p>No Google Photos available. Please <a href="{{ url_for('authorize') }}">authorize</a> the app to view your album.</p>
</section>
{% endif %}

<!-- SECTION 3: CURATED PHOTOS & VIDEOS -->
<!--
<section id="curated-media" class="mb-5">
  <h2>Curated Campus Media</h2>
  <div class="row">
    {% for media in curated_media %}
    <div class="col-md-4 mb-3">
      <div class="card">
        {% if media.type == "image" %}
        <img src="{{ media.src }}" class="card-img-top" alt="Curated campus media">
        {% elif media.type == "video" %}
        <video controls class="w-100">
          <source src="{{ media.src }}" type="video/mp4">
          Your browser does not support HTML5 video.
        </video>
        {% endif %}
        <div class="card-body">
          <p class="card-text">{{ media.description }}</p>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</section>
-->

<!-- User Submissions Section -->
<section id="user-submissions" class="mb-5">
  <h2>Share Your Photos & Videos</h2>
  <p>
    Help us document light pollution on campus by uploading your own photos or videos and tagging their location.
  </p>
  <div class="row">
    <!-- Left Column: Upload Form -->
    <div class="col-md-6 upload-section">
      <form action="{{ url_for('index') }}" method="POST" enctype="multipart/form-data" class="mb-4">
        <!-- File Upload -->
        <div class="mb-3">
          <!-- Custom label acting as the button -->
          <label for="media_file" id="media_file_label" class="custom-file-label btn btn-secondary">
            Choose File
          </label>
          <!-- Hidden file input with capture attribute -->
          <input class="d-none" type="file" id="media_file" name="media_file" accept="image/*" capture="camera" required>
          <!-- Thumbnail preview element (initially hidden) -->
          <img id="photo_thumbnail" src="" alt="Image Preview" style="display:none; max-width:100px; margin-top:10px;">
        </div>
        
        

        <!-- Image Description -->
        <div class="mb-3">
          <label for="description" class="form-label">Image Description</label>
          <input type="text" class="form-control" id="description" name="description"
            placeholder="Describe the image and where it was taken" required>
        </div>
        <!-- Your Name -->
        <div class="mb-3">
          <label for="user_name" class="form-label">Your Name (Optional)</label>
          <input type="text" class="form-control" id="user_name" name="user_name" placeholder="Enter your name">
        </div>
        <!-- Location Picker -->
        <div class="mb-3">
          <label for="location" class="form-label">Click on the map to select where the photo was taken.</label>
          <!-- Map container for location selection -->
          <div id="map" style="height: 400px;"></div>
          <!-- Hidden fields to store latitude and longitude -->
          <input type="hidden" id="latitude" name="latitude">
          <input type="hidden" id="longitude" name="longitude">
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>
    </div>
    <!-- Right Column: Recent Submissions -->
    <div class="col-md-6 submissions-section">
      <h3>Recent Submissions</h3>
      <div class="row">
        {% for submission in user_submissions %}
        <div class="col-md-6 mb-3">
          <div class="card user-submission-card">
            {% set ext = submission.filename.split('.')[-1]|lower %}
            {% if ext in ['png', 'jpg', 'jpeg', 'gif'] %}
            <img src="{{ url_for('static', filename='uploads/' ~ submission.filename) }}" class="card-img-top"
              alt="User submitted image">
            {% endif %}
            <div class="card-body">
              <p>{{ submission.description }}</p>
              {% if submission.user_name %}
              <p><strong>Submitted by:</strong> {{ submission.user_name }}</p>
              {% endif %}
              {% if submission.latitude and submission.longitude %}
              {% set map_url = "https://maps.googleapis.com/maps/api/staticmap?center="
              ~ submission.latitude ~ "," ~ submission.longitude
              ~ "&zoom=16&size=200x200&markers=color:red%7C"
              ~ submission.latitude ~ "," ~ submission.longitude
              ~ "&key=AIzaSyDzOZrj3M3hse4aBLL4sZrFnelsVdz12HQ" %}
              {% set maps_link = "https://www.google.com/maps/search/?api=1&query="
              ~ submission.latitude ~ "," ~ submission.longitude %}
              <a href="{{ maps_link }}" target="_blank">
                <img src="{{ map_url }}" alt="Map" style="width:200px; height:200px; display:block; margin-top:10px;">
              </a>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</section>

{% endblock %}
